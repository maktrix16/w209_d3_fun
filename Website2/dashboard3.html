<html>
	<head>
		<title>GeoViz v2</title>
		<script src="js/jquery-2.1.4.min.js" type="text/javascript"></script>
		<link rel="stylesheet" href="libs/bootstrap-3.3.6-dist/css/bootstrap.min.css">
		<script src="libs/bootstrap-3.3.6-dist/js/bootstrap.min.js"></script>
		<script type="text/javascript" src="js/jquery.sparkline.min.js"></script>
		<script src="https://code.highcharts.com/highcharts.js"></script>
		<script src="https://code.highcharts.com/modules/exporting.js"></script>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
<!-- 	  
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
	  <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
 -->
		<link rel="stylesheet" type="text/css" href="libs/leaflet/leaflet.css">
		<script type="text/javascript" src="libs/leaflet/leaflet.js"></script>

		<style>
			.chart div {
			  font: 10px sans-serif;
			  background-color: #348ABD;
			  text-align: right;
			  padding: 3px;
			  margin: 1px;
			  color: white;
			}

			#leaflet-map { height: 350px; width:500px;}

		</style>

	</head>
	<body>
		<div class="container">
			<h2 style="text-align:center">GeoTracking Interactive Dashboard</h2>
			<br>
			<div class="row">
				<div class="col-md-6 text-center">
					<div id="map" style="width:500px; height:350px"></div>

					<table style='width:100%'>
						<tr>
							<td style="width:45%; text-align:right">
								<select onchange="update()" id="dropdown1">
								  <option value="0">2008-Season 2</option>
								  <option value="1">2008-Season 3</option>
								  <option value="2">2008-Season 4</option>
								  <option value="3">2009-Season 1</option>
								  <option value="4">2009-Season 2</option>
								  <option value="5">2009-Season 3</option>
								</select>
							</td>
							<td style="width:10%"></td>
							<td style="width:45%">
								<div class="btn-group" role="group" aria-label="...">
								  <button type="button" class="btn btn-default" onclick="back()" id="btn_back" disabled="disabled"><i class="fa fa-step-backward"></i></button>
								  <button type="button" class="btn btn-default" onclick="next()" id="btn_fwd"><i class="fa fa-step-forward"></i></button>
								  <!-- <button type="button" class="btn btn-default" onclick="play_pause()"><i class="fa fa-play"></i></button> -->
								</div>	
							</td>
						</tr>
					</table>
				</div>

				<div class="col-md-6">
					<table class="table table-striped" id="tbl">
						<thead>
							<tr>
								<th>Mode</th>
								<th style="width:150px"></th>
								<th style="text-align:right">Distance</th>
								<th style="text-align:right">Duration</th>
								<th style="text-align:center">Trend</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
					<br>
				</div>
			</div>

			<!-- LEAFLET GRAPHIC --> 
			<div class='row'>
				<div class='col-md-6' id='leaflet-map'></div>
				<div id='leaflet-map'></div>
			</div>



		</div>
	</body>
</html>

<!-- all data stored in js file -->
<script type="text/javascript" src="js/data.js"></script>  

<!-- leaflet map section-->
<script type="text/javascript"> 
  function create_map (data){

  	//position map to center of Beijing
	  var map = L.map('leaflet-map').setView([39.952, 116.370], 11);

  	console.log(data);

  	for (i in data){
  		data_transport = data[i]
  		line_color = data_transport.color;
  		dataXY = data_transport.data;

  		var pointList = [];

  		for (j in dataXY){
  			var x = dataXY[j][0];
  			var y = dataXY[j][1];
  			console.log(x);
  			console.log(y);

  			pointList.push(L.latLng(x,y));

  		}

  		var path = L.polyline(pointList, {
			  // color: 'blue',
			  color: line_color,
			  weight: 1,
			  opacity: 0.5,
			  smoothFactor: 1

  		});
  		path.addTo(map);

  	}

  	// API call to mapbox.com
	  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
	      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
	      maxZoom: 18,
	      id: 'maktrix.oai34h1p',
	      accessToken: 'sk.eyJ1IjoibWFrdHJpeCIsImEiOiJjaWhvYmc3MDEwYXEwdGhqNzF5NHhsaXNlIn0.zCNGMBx_p9bZoKmi5JUfvg'
	  }).addTo(map);

	  var popup = L.popup();

	  function onMapClick(e) {
	      popup
		      .setLatLng(e.latlng)
		      .setContent("You clicked the map at " + e.latlng.toString())
		      .openOn(map);
	  }

	  map.on('click', onMapClick);

  }


</script> <!-- end of leaflet code -->


<!-- main javascript code section -->
<script type="text/javascript"> 

	// $("#sl1").sparkline([5,6,7,9,9,5,3,2,2,4,6,7,1,2,2,5,4,2,21,7,8], {type: 'line'});	
	
	var modes = ['walk', 'bike', 'car', 'taxi', 'bus', 'subway'];
	var seasons = ['2008-2', '2008-3', '2008-4', '2009-1', '2009-2', '2009-3'];
	var mode_colors = {'walk': '#fbb4ae', 'bike': '#b3cde3', 'car': '#ccebc5', 'taxi': '#decbe4', 'bus': '#fed9a6', 'subway': '#ffffcc'};
	var season_index = 0;
	display();
	plot_xy(data_xy[seasons[season_index]]);  //REMOVE LATER

	create_map(data_xy[seasons[season_index]]);

	function capitalize(string) {
	    return string.charAt(0).toUpperCase() + string.slice(1);
	}

	function next() {
		if (season_index >= 4) {
			season_index = 5;
			$("#btn_fwd").prop('disabled', true);
		}
		else{
			season_index += 1;
			$("#btn_back").prop('disabled', false);
		}

		display();
		plot_xy(data_xy[seasons[season_index]]); //REMOVE LATER

		create_map(data_xy[seasons[season_index]])

	}

	function back() {
		if (season_index <= 1) {
			season_index = 0;
			$("#btn_back").prop('disabled', true);
		}
		else{
			season_index -= 1;
			$("#btn_fwd").prop('disabled', false);
		}

		display();
		plot_xy(data_xy[seasons[season_index]]); //REMOVE LATER

		create_map(data_xy[seasons[season_index]])

	}

	function update() {
		season_index = parseInt($('#dropdown1').val());

		if (season_index >= 5) {
			$("#btn_fwd").prop('disabled', true);
			$("#btn_back").prop('disabled', false);
		}
		else if (season_index <= 0) {
			$("#btn_back").prop('disabled', true);
			$("#btn_fwd").prop('disabled', false);
		}
		else{
			$("#btn_fwd").prop('disabled', false);
			$("#btn_back").prop('disabled', false);
		}

		display();
		plot_xy(data_xy[seasons[season_index]]); //REMOVE LATER

		create_map(data_xy[seasons[season_index]])

	}

	function display() {
		$('#tbl tbody').html('');
		$("#dropdown1").val(season_index.toString());
		var season = seasons[season_index];
		paths_count = 0
		for (var mode in data[season]) {
			paths_count += data[season][mode]['paths'];
		}

		for (var i in modes) {
			mode = modes[i];

			if (mode in data[season]) {
				data_ = data[season][mode];
				avg_dist = (data_['distance'] / data_['paths'] / 1000.).toFixed(1) + '<span style="color:gray;font-size:x-small"> km</span>';
				avg_dur = (data_['duration'] / data_['paths']).toFixed(1) + '<span style="color:gray;font-size:x-small"> min</span>';
				path_pct = (250 * data[season][mode]['paths'] / paths_count).toFixed(0);
				hourly = data_['hourly'].join();
			}
			else{
				path_pct = 'N/A';
				avg_dist = 'N/A';
				avg_dur = 'N/A';
				hourly = '';
			}

			html = '<tr><td> <i class="fa fa-circle" style="color:' + mode_colors[mode] + '"></i> ' + capitalize(mode) + '</td>';
			html += '<td><div class="chart"><div style="width: ' + path_pct + 'px"></div></div></td>';
			html += '<td style="text-align:right">' + avg_dist + '</td>';
			html += '<td style="text-align:right">' + avg_dur + '</td><td><span class="inlineline">' + hourly + '</span></td></tr>';
			$("#tbl tbody").append(html);
		}

		// $('.inlinebar').sparkline('html', {type: 'bar', barColor: '#348ABD'} );
		$('.inlineline').sparkline('html', {type: 'line', barColor: '#348ABD'} );
		// $('.inlinebox').sparkline('html', {type: 'box', barColor: '#348ABD'} );
	}

	function plot_xy(data_xy) {
		$('#map').highcharts({
	        chart: {
	            type: 'scatter',
	            zoomType: 'xy'
	        },
	        title: {
	            text: null
	        },
	        subtitle: {
	            text: null
	        },
	        exporting: {
	        	enabled: false
	        },
	        credits: {
	        	enabled: false
	        },
	        xAxis: {
	            
	            title: null,
	            labels: {enabled: false},
	            startOnTick: true,
	            endOnTick: true,
	            showLastLabel: true
	        },
	        yAxis: {
	            lineWidth: 0,
	               minorGridLineWidth: 0,
	               lineColor: 'transparent',
	            title: null,
	            labels: {enabled: false},
	        },
	        plotOptions: {
	            scatter: {
	                marker: {
	                    radius: 5,
	                    states: {
	                        hover: {
	                            enabled: true,
	                            lineColor: 'rgb(100,100,100)'
	                        }
	                    }
	                },
	                states: {
	                    hover: {
	                        marker: {
	                            enabled: false
	                        }
	                    }
	                },
	                tooltip: {
	                    headerFormat: '<b>{series.name}</b><br>',
	                    pointFormat: '{point.x} lat, {point.y} lon'
	                }
	            }
	        },
	        series: data_xy
	    });
	}
</script>